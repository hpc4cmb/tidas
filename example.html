<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Examples &#8212; TIDAS 85f9226.dev135
 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '85f9226.dev135',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Volumes" href="volume.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><img class="rightlogo" src="_static/tidas_logo_small.png" alt="Logo"/><h1 class="heading"><a href="index.html">
          <span>TIDAS 85f9226.dev135
 documentation</span></a></h1>
        <h2 class="heading"><span>Examples</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="install.html">Installation</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="volume.html">Volumes</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="examples">
<span id="example"></span><h1>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h1>
<p>It is always debatable whether the examples should come before or after the detailed documentation.  You should read through the following sections for more details about the different TIDAS objects, terminology, and use.</p>
<div class="section" id="simple-weather-data">
<h2>Simple &#8220;Weather&#8221; Data<a class="headerlink" href="#simple-weather-data" title="Permalink to this headline">¶</a></h2>
<p>In this toy example, we create a volume with the serial Python interface and
write some fake data.  Then we show how to copy a subset of that volume as well
as how to set up a linked volume that can have additional data objects added
to it.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1">##</span>
<span class="c1">##  TImestream DAta Storage (TIDAS)</span>
<span class="c1">##  Copyright (c) 2014-2017, all rights reserved.  Use of this source code </span>
<span class="c1">##  is governed by a BSD-style license that can be found in the top-level</span>
<span class="c1">##  LICENSE file.</span>
<span class="c1">##</span>

<span class="c1"># WARNING:  Running this script will generate a several GB of data...</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">calendar</span>

<span class="kn">import</span> <span class="nn">tidas</span>


<span class="c1"># The name of the volume</span>

<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;demo_weather&quot;</span>

<span class="c1"># Create the schemas for the data groups that we will have for each day</span>

<span class="n">wind_schema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;speed&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;Meters / second&quot;</span><span class="p">),</span>
    <span class="s2">&quot;direction&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;Degrees&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># sampled every 10 seconds</span>
<span class="n">wind_rate</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">/</span> <span class="mf">60.0</span>
<span class="n">wind_daysamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">24.0</span> <span class="o">*</span> <span class="mf">3600.0</span> <span class="o">*</span> <span class="n">wind_rate</span><span class="p">)</span>

<span class="n">thermal_schema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;temperature&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;Degrees Celsius&quot;</span><span class="p">),</span>
    <span class="s2">&quot;pressure&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;Millibars&quot;</span><span class="p">),</span>
    <span class="s2">&quot;humidity&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;Percent&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># sampled once per minute</span>
<span class="n">thermal_rate</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">60.0</span>
<span class="n">thermal_daysamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">24.0</span> <span class="o">*</span> <span class="mf">3600.0</span> <span class="o">*</span> <span class="n">thermal_rate</span><span class="p">)</span>

<span class="n">precip_schema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;rainfall&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;Centimeters&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># sampled every 5 minutes</span>
<span class="n">precip_rate</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">)</span>
<span class="n">precip_daysamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">24.0</span> <span class="o">*</span> <span class="mf">3600.0</span> <span class="o">*</span> <span class="n">precip_rate</span><span class="p">)</span>

<span class="n">day_seconds</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>

<span class="c1"># Remove the volume if it exists</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="c1"># Create the volume all at once.</span>

<span class="k">with</span> <span class="n">tidas</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;hdf5&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vol</span><span class="p">:</span>

    <span class="c1"># Get the root block of the volume</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">root</span><span class="p">()</span>

    <span class="n">volstart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">volstartsec</span> <span class="o">=</span> <span class="n">volstart</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;2018&quot;</span><span class="p">,</span> <span class="s2">&quot;2019&quot;</span><span class="p">]:</span>
        <span class="c1"># Add a block for this year</span>
        <span class="n">yb</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">block_add</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">monthnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
            <span class="c1"># Add a block for the month</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">monthnum</span><span class="p">]</span>
            <span class="n">mb</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">block_add</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

            <span class="n">weekday</span><span class="p">,</span> <span class="n">nday</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">monthnum</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nday</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

                <span class="n">daystart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">monthnum</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
                <span class="n">daystartsec</span> <span class="o">=</span> <span class="p">(</span><span class="n">daystart</span> <span class="o">-</span> <span class="n">volstart</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> \
                    <span class="o">+</span> <span class="n">volstartsec</span>

                <span class="c1"># Add a block for the day</span>
                <span class="n">day</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">block_add</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>

                <span class="c1"># Now we are going to add the data groups for this day.</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing data for </span><span class="si">{}</span><span class="s2"> </span><span class="si">{:02d}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>

                <span class="n">wind</span> <span class="o">=</span> <span class="n">tidas</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">wind_schema</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">wind_daysamples</span><span class="p">)</span>
                <span class="n">wind</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">group_add</span><span class="p">(</span><span class="s2">&quot;wind&quot;</span><span class="p">,</span> <span class="n">wind</span><span class="p">)</span>

                <span class="n">thermal</span> <span class="o">=</span> <span class="n">tidas</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">thermal_schema</span><span class="p">,</span> 
                    <span class="n">size</span><span class="o">=</span><span class="n">thermal_daysamples</span><span class="p">)</span>
                <span class="n">thermal</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">group_add</span><span class="p">(</span><span class="s2">&quot;thermal&quot;</span><span class="p">,</span> <span class="n">thermal</span><span class="p">)</span>

                <span class="n">precip</span> <span class="o">=</span> <span class="n">tidas</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">precip_schema</span><span class="p">,</span> 
                    <span class="n">size</span><span class="o">=</span><span class="n">precip_daysamples</span><span class="p">)</span>
                <span class="n">precip</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">group_add</span><span class="p">(</span><span class="s2">&quot;precip&quot;</span><span class="p">,</span> <span class="n">precip</span><span class="p">)</span>

                <span class="c1"># Write timestamps to all groups</span>

                <span class="n">wind</span><span class="o">.</span><span class="n">write_times</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">daystartsec</span><span class="p">,</span> 
                    <span class="n">daystartsec</span> <span class="o">+</span> <span class="n">day_seconds</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">wind_daysamples</span><span class="p">))</span>

                <span class="n">thermal</span><span class="o">.</span><span class="n">write_times</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">daystartsec</span><span class="p">,</span> 
                    <span class="n">daystartsec</span> <span class="o">+</span> <span class="n">day_seconds</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">thermal_daysamples</span><span class="p">))</span>

                <span class="n">precip</span><span class="o">.</span><span class="n">write_times</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">daystartsec</span><span class="p">,</span> 
                    <span class="n">daystartsec</span> <span class="o">+</span> <span class="n">day_seconds</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">precip_daysamples</span><span class="p">))</span>

                <span class="c1"># Write some random data to the fields</span>

                <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="n">monthnum</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> 
                    <span class="n">size</span><span class="o">=</span><span class="n">wind_daysamples</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">wind</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="mf">360.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">wind_daysamples</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">wind</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>                

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">25.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> 
                    <span class="n">size</span><span class="o">=</span><span class="n">thermal_daysamples</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">thermal</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">1013.25</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> 
                    <span class="n">size</span><span class="o">=</span><span class="n">thermal_daysamples</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">thermal</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> 
                    <span class="n">size</span><span class="o">=</span><span class="n">thermal_daysamples</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">thermal</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;humidity&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="mf">360.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">precip_daysamples</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">precip</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rainfall&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="c1"># Now that we have our initial dataset, there are several things we might want</span>
<span class="c1"># to do with it.  Pretend this volume was actually huge and located at a</span>
<span class="c1"># computing center far away.  We want to get just a small subset to play </span>
<span class="c1"># with on our laptop.</span>

<span class="c1"># Let&#39;s say we only care about wind data, and in fact we are only </span>
<span class="c1"># interested in the speed, not the direction.  Let&#39;s extract just the wind</span>
<span class="c1"># speed data for the month of January, 2019.</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Small demo&quot;</span><span class="p">)</span>

<span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;demo_weather_small&quot;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tidas</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">vol</span><span class="p">:</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">duplicate</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;hdf5&quot;</span><span class="p">,</span> 
        <span class="n">selection</span><span class="o">=</span><span class="s2">&quot;/2019/Jan/.*[grp=wind[schm=speed]]&quot;</span><span class="p">)</span>

<span class="c1"># Take a quick peek at the small data volume:</span>

<span class="k">with</span> <span class="n">tidas</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">vol</span><span class="p">:</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>

<span class="c1"># Now consider another use case.  We have our original dataset which is</span>
<span class="c1"># priceless and we have changed the permissions on it so that it is read-only.</span>
<span class="c1"># However, we want to do some operations on that original data and produce some</span>
<span class="c1"># new derived data products.  We can make a volume which links to the original</span>
<span class="c1"># data and then add new groups to this.</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Link demo&quot;</span><span class="p">)</span>

<span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;demo_weather_link&quot;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tidas</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">vol</span><span class="p">:</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="c1"># The resulting volume has symlinks at the group / interval level to the</span>
<span class="c1"># original read-only files.  Now open this volume up and make some new</span>
<span class="c1"># new intervals that will be only in our local linked copy of the volume:</span>

<span class="k">with</span> <span class="n">tidas</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vol</span><span class="p">:</span>
    <span class="c1"># Get the root block of the volume</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">root</span><span class="p">()</span>

    <span class="n">years</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">blocks</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">block_names</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">yr</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">years</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">months</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">blocks</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">block_names</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">mn</span><span class="p">,</span> <span class="n">mb</span> <span class="ow">in</span> <span class="n">months</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">days</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">blocks</span><span class="p">(</span><span class="n">mb</span><span class="o">.</span><span class="n">block_names</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">dy</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">days</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Pretend that we have 10 spans of time where the temperature</span>
                <span class="c1"># is &quot;low&quot;.  Just fake uniform intervals here...</span>
                <span class="n">nlow</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="mi">20</span>
                <span class="n">span</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">/</span> <span class="n">thermal_rate</span>

                <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlow</span><span class="p">):</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">span</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">span</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">chunk</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tidas</span><span class="o">.</span><span class="n">Intrvl</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                        <span class="n">first</span><span class="o">=</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="n">last</span><span class="p">))</span>

                <span class="n">lowtemps</span> <span class="o">=</span> <span class="n">tidas</span><span class="o">.</span><span class="n">Intervals</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">nlow</span><span class="p">)</span>
                <span class="n">lowtemps</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">intervals_add</span><span class="p">(</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="n">lowtemps</span><span class="p">)</span>
                <span class="n">lowtemps</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Take a quick peek- all the original groups linked in appear to be</span>
<span class="c1"># in this volume.  However, note that trying to write to these would fail</span>
<span class="c1"># if the filesystem permissions were read-only.</span>

<span class="k">with</span> <span class="n">tidas</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">vol</span><span class="p">:</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="install.html">Installation</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="volume.html">Volumes</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2014-2017, Theodore Kisner.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.
    </div>
  </body>
</html>